import { file_append } from "std/fs"


let usecases = ["webhook-direct", "webhook-tgin", "longpull-tgin", "longpull-direct"]

let rps_values = [100, 200, 300, 400, 500]

main {
    $ make clean $?
    $ make build $?
    
    for rps in rps_values {
        for mode in usecases {
            let output = $ make {mode} RPS={rps} $?
            let sent = $ echo "{output}" | grep "Requests Sent:" | tr -s ' ' | xargs | cut -d ' ' -f 3 $?
            let recv = $ echo "{output}" | grep "Responses Recv:" | tr -s ' ' | xargs | cut -d ' ' -f 3 $?
            let errors = $ echo "{output}" | grep "Errors (Net):" | tr -s ' ' | xargs | cut -d ' ' -f 3 $?
            let loss = $ echo "{output}" | grep "Loss Rate:" | tr -s ' ' | xargs | cut -d ' ' -f 3 | tr -d '%' $?
            
            let min = $ echo "{output}" | grep "Min:" | tr -s ' ' | xargs | cut -d ' ' -f 2 $?
            let mean = $ echo "{output}" | grep "Mean:" | tr -s ' ' | xargs | cut -d ' ' -f 2 $?
            let p50 = $ echo "{output}" | grep "p50:" | tr -s ' ' | xargs | cut -d ' ' -f 2 $?
            let p95 = $ echo "{output}" | grep "p95:" | tr -s ' ' | xargs | cut -d ' ' -f 2 $?
            let p99 = $ echo "{output}" | grep "p99:" | tr -s ' ' | xargs | cut -d ' ' -f 2 $?
            let max = $ echo "{output}" | grep "Max:" | tr -s ' ' | xargs | cut -d ' ' -f 2 $?

            echo mode
            
            echo "RPS={rps} -> Sent: {sent}, Resv: {recv}, Errors: {errors}, Loss: {loss}%,  Min: {min}ms, Mean: {mean}ms, P50: {p50}ms, P95: {p95}ms, P99: {p99}ms, Max: {max}ms"

            file_append("results.csv", "{mode},{rps},{sent},{recv},{errors},{loss},{min},{mean},{p50},{p95},{p99},{max}")?

            $ make clean $?
        }
    }
}